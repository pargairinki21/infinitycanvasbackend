<!DOCTYPE html>
<html>
<head>
  <title>Form Finder</title>
</head>
<body>
  <h1>Voice Form Assistant</h1>

  <!-- Voice Button -->
  <button id="runBtn">‚ñ∂üéôÔ∏è Voice Assistant</button>

  <!-- Chat Input -->
  <div style="margin-top: 1em;">
    <label for="chatInput">üí¨ Chat Assistant:</label>
    <input id="chatInput" type="text" placeholder="Type your query here..." style="width: 300px;">
    <button id="chatBtn">Send</button>
  </div>

  <!-- Log Output -->
  <pre id="logBox" style="height:300px;overflow:auto;border:1px solid #ccc"></pre>

  <!-- JavaScript -->
  <script>
let audioContext, processor, input, globalStream;
let audioData = [];
let voiceActive = false;

runBtn.onclick = () => {
  if (voiceActive) {
    stopVoiceAssistant();
  } else {
    startVoiceAssistant();
  }
};

async function startVoiceAssistant() {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    input = audioContext.createMediaStreamSource(globalStream);
    processor = audioContext.createScriptProcessor(4096, 1, 1);

    processor.onaudioprocess = e => {
      const channel = e.inputBuffer.getChannelData(0);
      audioData.push(new Float32Array(channel));
    };

    input.connect(processor);
    processor.connect(audioContext.destination);

    voiceActive = true;
    runBtn.textContent = "‚èπÔ∏è Stop Voice Assistant";
    appendChatLine("assistant", "üé§ Listening...");
  } catch (err) {
    appendChatLine("assistant", "‚ö†Ô∏è Mic access denied: " + err.message);
  }
}

function stopVoiceAssistant() {
  processor.disconnect();
  input.disconnect();
  globalStream.getTracks().forEach(track => track.stop());
  audioContext.close();

  const wavBlob = encodeWAV(audioData, audioContext.sampleRate);
  sendAudio(wavBlob);   // <-- actually sends to backend

  audioData = [];
  voiceActive = false;
  runBtn.textContent = "‚ñ∂üéôÔ∏è Voice Assistant";
}

// === WAV ENCODER ===
function encodeWAV(buffers, sampleRate) {
  let length = buffers.reduce((acc, cur) => acc + cur.length, 0);
  let pcm = new Float32Array(length);
  let offset = 0;
  for (let b of buffers) {
    pcm.set(b, offset);
    offset += b.length;
  }

  // WAV file buffer
  let buffer = new ArrayBuffer(44 + pcm.length * 2);
  let view = new DataView(buffer);

  function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  }

  // RIFF chunk
  writeString(view, 0, "RIFF");
  view.setUint32(4, 36 + pcm.length * 2, true);
  writeString(view, 8, "WAVE");
  writeString(view, 12, "fmt ");
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true); // PCM
  view.setUint16(22, 1, true); // mono
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(view, 36, "data");
  view.setUint32(40, pcm.length * 2, true);

  // PCM samples
  let idx = 44;
  for (let i = 0; i < pcm.length; i++, idx += 2) {
    let s = Math.max(-1, Math.min(1, pcm[i]));
    view.setInt16(idx, s < 0 ? s * 0x8000 : s * 0x7fff, true);
  }

  return new Blob([view], { type: "audio/wav" });
}

// === SEND AUDIO TO BACKEND ===
async function sendAudio(blob) {
  const formData = new FormData();
  formData.append("file", blob, "audio.wav");

  appendChatLine("user", "üé§ [Voice query sent]");

  try {
    const resp = await fetch("http://127.0.0.1:8001/process_audio", {
      method: "POST",
      body: formData
    });
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    const data = await resp.json();
   appendChatLine("assistant", data.message || "‚úÖ Chat processed.");

  } catch (err) {
    appendChatLine("assistant", "‚ùå Error: " + err.message);
  }
}

// === SEND CHAT TEXT TO BACKEND ===
chatBtn.onclick = async () => {
  const text = chatInput.value.trim();
  if (!text) return;
  appendChatLine("user", text);
  chatInput.value = "";

  try {
    const resp = await fetch("http://127.0.0.1:8001/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    const data = await resp.json();
    appendChatLine("assistant", data.message || "‚úÖ Chat processed.");
  } catch (err) {
    appendChatLine("assistant", "‚ùå Error: " + err.message);
  }
};

// === LOGGING CHAT ===
function appendChatLine(role, msg) {
  const logBox = document.getElementById("logBox");
  logBox.textContent += (role === "user" ? "üë§ " : "ü§ñ ") + msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}
</script>
</body>
</html>
